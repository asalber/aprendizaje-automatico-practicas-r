{
  "hash": "421a4bb8ea4ae7d09ba40dba8aa9a9eb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Regresión\nexecute: \n  warning: false\nlang: es\n---\n\nLos modelos de aprendizaje basados en regresión son modelos bastante simples que pueden utilizarse para predecir variables cuantitativas (regresión lineal o no lineal) o cualitativas (regresión logística). Esta práctica contiene ejercicios que muestran como construir modelos de aprendizaje de regresión lineal, no lineal y regresión logística con R y el paquete `tidymodels`.\n\n## Ejercicios Resueltos\n\nPara la realización de esta práctica se requieren los siguientes paquetes:\n\n```R\nlibrary(rdatasets) # Para cargar conjuntos de datos.\nlibrary(tidyverse)\n# Incluye los siguientes paquetes:\n# - readr: para la lectura de ficheros csv.\n# - dplyr: para el preprocesamiento y manipulación de datos.\n# - ggplot2: para la visualización de datos.\nlibrary(GGally) # para la visualización de datos.\nlibrar(tidymodels) # para la creación de modelos de aprendizaje automático.\nlibrary(broom) # para convertir las listas con los resúmenes de los modelos de regresión a formato organizado.\nlibrary(knitr) # para el formateo de tablas.\n```\n\n:::{#exr-regresion-1}\nEl conjunto de datos [medidas-fisicas.csv](datos/medidas-fisicas.csv) contiene un conjunto de datos con la edad, sexo, estatura (cm), peso (kg) y el deporte que hacen una muestra de personas (días a la semana).\n\na.  Cargar los datos del archivo [`medidas-fisicas.csv`](https://aprendeconalf.es/aprendizaje-automatico-practicas-r/datos/medidas-fisicas.csv) en un data frame.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(tidyverse)\n    library(knitr)\n    df <- read_csv(\"datos/medidas-fisicas.csv\") |> \n    mutate(Peso = if_else(DiasDeporte > 0, Peso - DiasDeporte/2, Peso))\n    head(df) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    | Edad|Sexo   | Estatura| Peso| DiasDeporte|\n    |----:|:------|--------:|----:|-----------:|\n    |   34|hombre |    164.7| 87.4|           0|\n    |    4|hombre |    105.4| 17.0|           0|\n    |   49|mujer  |    168.4| 86.7|           0|\n    |    9|hombre |    133.1| 29.8|           0|\n    |    8|hombre |    130.6| 35.2|           0|\n    |   45|mujer  |    166.7| 67.7|           5|\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Preprocesar el conjunto de datos filtrando las personas mayores de edad y eliminando las filas con con datos perdidos.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df <- df  |> \n        filter(Edad >= 18)  |> \n        drop_na()\n    ```\n    :::\n\n    :::\n\na.  Dibujar un diagrama de relación entre todos los pares de variables del conjunto de datos diferenciando por el sexo de las personas.\n\n    :::{.callout-note collapse=\"true\"}\n    ## Ayuda\n    Se puede utilizar la función `ggpairs` del paquete `GGally` para dibujar un diagrama de relación entre todos los pares de variables del conjunto de datos. Asociar el sexo a la dimensión del color.\n    :::\n\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(GGally)\n    ggpairs(df, aes(color = Sexo, alpha = 0.5))\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-3-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Descomponer el conjunto de datos en un subconjunto de entrenamiento con el 80% de los datos y un subconjunto de test con el 20% restante.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(tidymodels)\n    set.seed(123) # Semilla aleatoria para reproducibilidad\n    df_particion <- initial_split(df, prop = 0.8)  # Dividir el conjunto de datos en entrenamiento (80%) y test (20%)\n    df_entrenamiento <- training(df_particion)\n    df_test <- testing(df_particion)\n    ```\n    :::\n\n    :::\n\na.  Dibujar el diagrama de dispersión de la estatura y el peso.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    diagrama_dispersion <- ggplot(df_entrenamiento, aes(x = Estatura, y = Peso)) +\n      geom_point() +\n      labs(title = \"Diagrama de dispersión de Estatura y Peso\")\n    diagrama_dispersion\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-5-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Construir un modelo de regresión lineal para predecir el peso en función de la estatura.\n\n    :::{.callout-note collapse=\"true\"}\n    ## Ayuda\n    Utilizar la función `lm` del paquete `base` para crear un modelo de regresión lineal con la fórmula `Peso ~ Estatura` para indicar que el peso es la variable dependiente y la estatura es la variable independiente.\n\n    O bien, utilizar la función `linear_reg` del paquete `tidymodels` para crear un modelo de regresión lineal y usar la función `set_engine` para establecer el motor de cálculo como \"lm\" (mínimos cuadrados).\n    Una vez definido el tipo de modelo, utilizar la función `fit` para ajustar el modelo a los datos, pasándole la fórmula `Peso ~ Estatura` para indicar que el peso es la variable dependiente y la estatura es la variable independiente.\n    :::\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n    :::{.panel-tabset}\n    ## Base\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(broom)\n    modelo <- lm(Peso ~ Estatura, data = df_entrenamiento)  # Crear un modelo de regresión lineal.\n    tidy(modelo) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |term        |    estimate| std.error| statistic| p.value|\n    |:-----------|-----------:|---------:|---------:|-------:|\n    |(Intercept) | -69.3115840| 5.4317717|  -12.7604|       0|\n    |Estatura    |   0.8799128| 0.0322225|   27.3074|       0|\n    \n    \n    :::\n    :::\n\n\n    ## Tidymodels\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    modelo <- linear_reg() |>   # Crear un modelo de regresión lineal.\n        set_engine(\"lm\")  # Establecer como motor de cálculo el ajuste por mínimos cuadrados.\n    \n    modelo_ajustado <- modelo |>\n        fit(Peso ~ Estatura, data = df_entrenamiento) # Ajustar el modelo a los datos.  \n    tidy(modelo_ajustado) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |term        |    estimate| std.error| statistic| p.value|\n    |:-----------|-----------:|---------:|---------:|-------:|\n    |(Intercept) | -69.3115840| 5.4317717|  -12.7604|       0|\n    |Estatura    |   0.8799128| 0.0322225|   27.3074|       0|\n    \n    \n    :::\n    :::\n\n    :::\n    :::\n\na.  Dibujar el modelo de regresión lineal sobre el diagrama de dispersión de la estatura y el peso.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    diagrama_dispersion +\n      geom_smooth(method = \"lm\") \n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-8-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Predecir el peso de las personas del conjunto de test utilizando el modelo de regresión lineal ajustado.\n\n    :::{.callout-note collapse=\"true\"}\n    ## Ayuda\n    Utilizar la función `predict` del paquete `base` para predecir el peso de las personas del conjunto de test. Pasar el modelo ajustado y el conjunto de datos de test como argumentos.\n    :::\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df_test <- df_test |> \n        mutate(Peso_Predicho = predict(modelo_ajustado, new_data = df_test)$.pred)  # Predecir el peso de las personas del conjunto de test.\n    head(df_test) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    | Edad|Sexo   | Estatura|  Peso| DiasDeporte| Peso_Predicho|\n    |----:|:------|--------:|-----:|-----------:|-------------:|\n    |   54|hombre |    169.4|  73.1|           1|      79.74564|\n    |   50|hombre |    177.8|  71.5|           7|      87.13690|\n    |   33|hombre |    181.3|  93.8|           0|      90.21660|\n    |   37|mujer  |    154.8|  42.9|           5|      66.89891|\n    |   28|mujer  |    169.6| 134.3|           0|      79.92162|\n    |   30|hombre |    175.8|  88.4|           0|      85.37708|\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Dibujar los errores predictivos entre el peso real y el peso predicho en el conjunto de datos de test.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    ggplot(df_test, aes(x = Peso, y = Peso_Predicho)) +\n      geom_abline(slope = 1, intercept = 0, color = \"red\") +\n      geom_point() +\n      geom_segment(aes(xend = Peso, yend = Peso), color = \"blue\", alpha = 0.5) +\n      labs(title = \"Errores predictivos (líneas verticales) entre Peso Real y Predicho\",\n           x = \"Peso Real\",\n           y = \"Peso Predicho\")\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-10-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Evaluar el modelo de regresión lineal calculando el error cuadrático medio (RMSE) y el coeficiente de determinación ($R^2$).\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(yardstick)\n    df_test |> \n        metrics(truth = Peso, estimate = Peso_Predicho) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.metric |.estimator |  .estimate|\n    |:-------|:----------|----------:|\n    |rmse    |standard   | 19.1912493|\n    |rsq     |standard   |  0.1715209|\n    |mae     |standard   | 14.9523600|\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Incluir en el modelo de regresión lineal la variable sexo como variable categórica y volver a ajustar el modelo.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    modelo_ajustado_sexo <- modelo |>\n        fit(Peso ~ Estatura + Sexo, data = df_entrenamiento)\n    tidy(modelo_ajustado_sexo) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |term        |    estimate| std.error|  statistic|   p.value|\n    |:-----------|-----------:|---------:|----------:|---------:|\n    |(Intercept) | -71.8952720| 7.7052434| -9.3306945| 0.0000000|\n    |Estatura    |   0.8939739| 0.0438512| 20.3865224| 0.0000000|\n    |Sexomujer   |   0.4199595| 0.8882125|  0.4728142| 0.6363727|\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Dibujar el modelo de regresión lineal con la variable sexo sobre el diagrama de dispersión de la estatura y el peso.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n    \n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df_entrenamiento  |> \n        ggplot(aes(x = Estatura, y = Peso, color = Sexo)) +\n        geom_point() +\n        geom_smooth(method = \"lm\") \n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-13-1.png){width=672}\n    :::\n    \n    ```{.r .cell-code}\n        labs(title = \"Diagrama de dispersión de Estatura y Peso según Sexo\") \n    ```\n    \n    ::: {.cell-output .cell-output-stdout}\n    \n    ```\n    $title\n    [1] \"Diagrama de dispersión de Estatura y Peso según Sexo\"\n    \n    attr(,\"class\")\n    [1] \"labels\"\n    ```\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Predecir el peso de las personas del conjunto de test utilizando el modelo de regresión lineal ajustado con la variable sexo y evaluar el nuevo modelo de regresión lineal calculando el error cuadrático medio (RMSE) y el coeficiente de determinación ($R^2$). ¿Qué conclusiones puedes sacar de la comparación entre los dos modelos?\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df_test |> \n        mutate(Peso_Predicho = predict(modelo_ajustado_sexo, new_data = df_test)$.pred)  |>  # Predecir el peso de las personas del conjunto de test.\n        metrics(truth = Peso, estimate = Peso_Predicho) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.metric |.estimator | .estimate|\n    |:-------|:----------|---------:|\n    |rmse    |standard   | 19.188852|\n    |rsq     |standard   |  0.171704|\n    |mae     |standard   | 14.951605|\n    \n    \n    :::\n    :::\n\n\n    El error cuadrático medio no ha disminuido, por lo que la inclusión de la variable sexo no ha mejorado el modelo.\n    :::\n\n\na.  Construir un nuevo modelo que explique el peso en función de la estatura y el deporte que practican las personas.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    modelo_ajustado_deporte <- modelo |>\n        fit(Peso ~ Estatura + DiasDeporte, data = df_entrenamiento)\n    tidy(modelo_ajustado_deporte) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |term        |    estimate| std.error| statistic| p.value|\n    |:-----------|-----------:|---------:|---------:|-------:|\n    |(Intercept) | -69.7060760| 5.2092631| -13.38118|       0|\n    |Estatura    |   0.9091978| 0.0309437|  29.38234|       0|\n    |DiasDeporte |  -2.5440654| 0.1390180| -18.30026|       0|\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Dibujar el modelo de regresión lineal con la variable deporte sobre el diagrama de dispersión de la estatura y el peso.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df_entrenamiento  |> \n        ggplot(aes(x = Estatura, y = Peso, color = DiasDeporte)) +\n        geom_point() +\n        geom_smooth(method = \"lm\") +\n        labs(title = \"Diagrama de dispersión de Estatura y Peso según Días de Deporte\") \n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-16-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Evaluar el nuevo modelo de regresión lineal calculando el error cuadrático medio (RMSE) y el coeficiente de determinación ($R^2$). ¿Qué conclusiones puedes sacar ahora?\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df_test |> \n        mutate(Peso_Predicho = predict(modelo_ajustado_deporte, new_data = df_test)$.pred)  |>  # Predecir el peso de las personas del conjunto de test.\n        metrics(truth = Peso, estimate = Peso_Predicho) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.metric |.estimator |  .estimate|\n    |:-------|:----------|----------:|\n    |rmse    |standard   | 18.4424646|\n    |rsq     |standard   |  0.2351604|\n    |mae     |standard   | 14.3124504|\n    \n    \n    :::\n    :::\n\n\n    El error cuadrático medio ha disminuido un poco, pero aún así la inclusión de la variable deporte no ha mejorado mucho el modelo.\n    :::\n:::\n\n:::{#exr-regresion-5}\nEl fichero [`dieta.csv`](datos/dieta.csv) contiene información sobre el los kilos perdidos con una dieta de adelgazamiento.\n\na.  Crear un data frame con los datos de la dieta a partir del fichero [`dieta.csv`](https://aprendeconalf.es/estadistica-practicas-r/datos/dieta.csv).\n\n    :::{.callout-tip collapse=\"true\"} \n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(tidyverse)\n    library(knitr)\n    df <- read_csv(\"datos/dieta.csv\")\n    head(df) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    | dias| peso_perdido|ejercicio |\n    |----:|------------:|:---------|\n    |   14|         2.95|no        |\n    |   18|         5.65|no        |\n    |   22|         6.56|no        |\n    |   26|         3.56|no        |\n    |   30|         6.17|no        |\n    |   34|         9.40|no        |\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Dibujar el diagrama de dispersión de los kilos perdidos en función del número de días con la dieta. ¿Qué tipo de modelo de regresión se ajusta mejor a la nube de puntos?\n\n    :::{.callout-tip collapse=\"true\"} \n    ## Solución\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    ggplot(df, aes(x = dias, y = peso_perdido)) +\n        geom_point() +\n        labs(title = \"Diagrama de dispersión del peso perdido y los días de dieta\", x = \"Días de dieta\", y = \"Peso perdido en Kg\")\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-19-1.png){width=672}\n    :::\n    :::\n\n    La nube de puntos es bastante difusa aunque parece apreciarse una tendencia logarítmica o sigmoidal.\n    :::\n\na.  Dividir el conjunto de datos en un subconjunto de entrenamiento con el 75% de los datos y un subconjunto de test con el 25% restante.\n\n    :::{.callout-tip collapse=\"true\"} \n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    set.seed(123) # Semilla aleatoria para reproducibilidad\n    df_particion <- initial_split(df, prop = 0.75)  # Dividir el conjunto de datos en entrenamiento (75%) y test (25%)\n    df_entrenamiento <- training(df_particion)\n    df_test <- testing(df_particion)\n    ```\n    :::\n\n    :::\n\na.  Ajustar un modelo de regresión sigmoidal a los datos de la dieta y evaluarlo mediante validación cruzada con 5 pliegues.\n    \n    :::{.callout-tip collapse=\"true\"} \n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    modelo <- linear_reg() |> \n        set_engine(\"lm\") \n    df_cv <- vfold_cv(df_entrenamiento, v = 5) # Validación cruzada con 10 pliegues.\n    workflow() |> \n        add_model(modelo) |> \n        add_formula(log(peso_perdido) ~ I(1/dias))  |>  # Añadir el modelo y la fórmula al flujo de ajuste.\n        fit_resamples(resamples = df_cv)  |> # Ajustar el modelo a los pliegues de validación cruzada.\n        collect_metrics() |> \n        kable() \n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.metric |.estimator |      mean|  n|   std_err|.config              |\n    |:-------|:----------|---------:|--:|---------:|:--------------------|\n    |rmse    |standard   | 0.3296714|  5| 0.0472280|Preprocessor1_Model1 |\n    |rsq     |standard   | 0.6360074|  5| 0.0529945|Preprocessor1_Model1 |\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Ajustar un modelo de regresión inverso a los datos de la dieta y evaluarlo mediante validación cruzada con 5 pliegues.\n\n    :::{.callout-tip collapse=\"true\"} \n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    workflow() |> \n        add_model(modelo) |> \n        add_formula(peso_perdido ~ I(1/dias))  |>  # Añadir el modelo y la fórmula al flujo de ajuste.\n        fit_resamples(resamples = df_cv)  |> # Ajustar el modelo a los pliegues de validación cruzada.\n        collect_metrics() |> \n        kable() \n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.metric |.estimator |      mean|  n|   std_err|.config              |\n    |:-------|:----------|---------:|--:|---------:|:--------------------|\n    |rmse    |standard   | 3.5477148|  5| 0.3300098|Preprocessor1_Model1 |\n    |rsq     |standard   | 0.6146749|  5| 0.0458547|Preprocessor1_Model1 |\n    \n    \n    :::\n    :::\n\n\na.  Ajustar un modelo de regresión potencial a los datos de la dieta y evaluarlo mediante validación cruzada con 5 pliegues.\n\n    :::{.callout-tip collapse=\"true\"} \n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    workflow() |> \n        add_model(modelo) |> \n        add_formula(log(peso_perdido) ~ log(dias))  |>  # Añadir el modelo y la fórmula al flujo de ajuste.\n        fit_resamples(resamples = df_cv)  |> # Ajustar el modelo a los pliegues de validación cruzada.\n        collect_metrics() |> \n        kable() \n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.metric |.estimator |      mean|  n|   std_err|.config              |\n    |:-------|:----------|---------:|--:|---------:|:--------------------|\n    |rmse    |standard   | 0.3410319|  5| 0.0432541|Preprocessor1_Model1 |\n    |rsq     |standard   | 0.6952170|  5| 0.0312989|Preprocessor1_Model1 |\n    \n    \n    :::\n    :::\n\n    :::\n\n:::{#exr-regresion-3}\nEl fichero [`infartos.csv`](datos/infartos.csv) contiene información sobre distintas variables fisiológicas relacionadas con el riesgo de infarto de una muestra de personas. Las variables que contienen son:\n\n- `Edad`: Edad del paciente (años)\n- `Sexo`: Sexo del paciente (H: hombre, M: mujer)\n- `DolorPecho`: Tipo de dolor torácico (TA: angina típica, ATA: angina atípica, NAP: dolor no anginoso, ASY: asintomático)\n- `PresionArterial`: Presión arterial sistólica en reposo (mm Hg)\n- `Colesterol`: Colesterol sérico (mm/dl)\n-  `Glucemia`: Glucemia en ayunas (1: si glucemia en ayunas > 120 mg/dl, 0: de lo contrario)\n- `Electro`: resultados del electrocardiograma en reposo (Normal: normal, ST: anomalía onda ST-T (inversiones de onda T y/o elevación o depresión de ST > 0,05 mV), LVH: hipertrofia ventricular izquierda probable o definitiva según criterios de Estes)\n- `Pulsaciones`: Frecuencia cardíaca máxima alcanzada (valor numérico entre 60 y 202)\n- `AnginaEjercicio`: Angina inducida por ejercicio (S: sí, N: no)\n- `DepresionST`: Depresión del segmento ST inducida por el ejercicio (valor numérico de la depresión).\n- `PendienteST`: Pendiente del segmento ST en el pico de ejercicio (Ascendente, Plano, Descencdente).\n- `Infarto`: Riesgo de infarto (1: Sí, 0: No)\n\na.  Cargar los datos del archivo [`infartos.csv`](https://aprendeconalf.es/aprendizaje-automatico-practicas-r/datos/infartos.csv) en un data frame.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución \n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(tidyverse)\n    library(knitr)\n    df <- read.csv(\"datos/infartos.csv\", stringsAsFactors = TRUE) \n    df |> \n        glimpse()\n    ```\n    \n    ::: {.cell-output .cell-output-stdout}\n    \n    ```\n    Rows: 918\n    Columns: 12\n    $ Edad            <int> 40, 49, 37, 48, 54, 39, 45, 54, 37, 48, 37, 58, 39, 49…\n    $ Sexo            <fct> H, M, H, M, H, H, M, H, H, M, M, H, H, H, M, M, H, M, …\n    $ DolorPecho      <fct> ATA, NAP, ATA, ASY, NAP, NAP, ATA, ATA, ASY, ATA, NAP,…\n    $ PresionArterial <int> 140, 160, 130, 138, 150, 120, 130, 110, 140, 120, 130,…\n    $ Colesterol      <int> 289, 180, 283, 214, 195, 339, 237, 208, 207, 284, 211,…\n    $ Glucemia        <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …\n    $ Electro         <fct> Normal, Normal, ST, Normal, Normal, Normal, Normal, No…\n    $ Pulsaciones     <int> 172, 156, 98, 108, 122, 170, 170, 142, 130, 120, 142, …\n    $ AnginaEjercicio <fct> N, N, N, S, N, N, N, N, S, N, N, S, N, S, N, N, N, N, …\n    $ DepresionST     <dbl> 0.0, 1.0, 0.0, 1.5, 0.0, 0.0, 0.0, 0.0, 1.5, 0.0, 0.0,…\n    $ PendienteST     <fct> Ascendente, Plano, Ascendente, Plano, Ascendente, Asce…\n    $ Infarto         <int> 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, …\n    ```\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Convertir las variables cualitativas en factores.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n        \n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df <- df |> \n        mutate(Infarto = factor(Infarto, levels = c(\"0\", \"1\"), labels = c(\"No\", \"Sí\")),\n        Glucemia = factor(Glucemia, levels = c(\"0\", \"1\"), labels = c(\"No\", \"Sí\")))\n    ```\n    :::\n\n    :::\n\na.  Realizar un análisis exploratorio de los datos.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(skimr)\n    df |> \n        skim() \n    ```\n    \n    ::: {.cell-output-display}\n    \n    Table: Data summary\n    \n    |                         |     |\n    |:------------------------|:----|\n    |Name                     |df   |\n    |Number of rows           |918  |\n    |Number of columns        |12   |\n    |_______________________  |     |\n    |Column type frequency:   |     |\n    |factor                   |7    |\n    |numeric                  |5    |\n    |________________________ |     |\n    |Group variables          |None |\n    \n    \n    **Variable type: factor**\n    \n    |skim_variable   | n_missing| complete_rate|ordered | n_unique|top_counts                           |\n    |:---------------|---------:|-------------:|:-------|--------:|:------------------------------------|\n    |Sexo            |         0|             1|FALSE   |        2|H: 725, M: 193                       |\n    |DolorPecho      |         0|             1|FALSE   |        4|ASY: 496, NAP: 203, ATA: 173, TA: 46 |\n    |Glucemia        |         0|             1|FALSE   |        2|No: 704, Sí: 214                     |\n    |Electro         |         0|             1|FALSE   |        3|Nor: 552, LVH: 188, ST: 178          |\n    |AnginaEjercicio |         0|             1|FALSE   |        2|N: 547, S: 371                       |\n    |PendienteST     |         0|             1|FALSE   |        3|Pla: 460, Asc: 395, Des: 63          |\n    |Infarto         |         0|             1|FALSE   |        2|Sí: 508, No: 410                     |\n    \n    \n    **Variable type: numeric**\n    \n    |skim_variable   | n_missing| complete_rate|   mean|     sd|   p0|    p25|   p50|   p75|  p100|hist  |\n    |:---------------|---------:|-------------:|------:|------:|----:|------:|-----:|-----:|-----:|:-----|\n    |Edad            |         0|             1|  53.51|   9.43| 28.0|  47.00|  54.0|  60.0|  77.0|▁▅▇▆▁ |\n    |PresionArterial |         0|             1| 132.40|  18.51|  0.0| 120.00| 130.0| 140.0| 200.0|▁▁▃▇▁ |\n    |Colesterol      |         0|             1| 198.80| 109.38|  0.0| 173.25| 223.0| 267.0| 603.0|▃▇▇▁▁ |\n    |Pulsaciones     |         0|             1| 136.81|  25.46| 60.0| 120.00| 138.0| 156.0| 202.0|▁▃▇▆▂ |\n    |DepresionST     |         0|             1|   0.89|   1.07| -2.6|   0.00|   0.6|   1.5|   6.2|▁▇▆▁▁ |\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Dibujar un diagrama de relación entre todos los pares de variables del conjunto de datos diferenciando por el riesgo de infarto.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n    \n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(GGally)\n    df |> \n        ggpairs(aes(color = Infarto, alpha = 0.5))\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-27-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Dibujar los diagramas de barras con la distribución de frecuencias de las variables cualitativas según el riesgo de infarto.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df |> \n        select(where(is.factor)) |> \n        pivot_longer(cols = where(is.factor) & !all_of(\"Infarto\"), names_to = \"variable\", values_to = \"valor\") |> \n        ggplot(aes(x = valor, fill = Infarto)) +\n        facet_wrap(~ variable, scales = \"free\") +\n        geom_bar() +\n        labs(title = \"Distribución de frecuencias de variables cualitativas\")\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-28-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Dibujar los diagramas de cajas de las variables numéricas según el riesgo de infarto.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df |>\n        select(Infarto, where(is.numeric)) |> \n        pivot_longer(cols = where(is.numeric), names_to = \"variable\", values_to = \"valor\") |>\n        ggplot(aes(x = Infarto, y = valor, fill = Infarto)) +\n        geom_boxplot() +\n        facet_wrap(~ variable, scales = \"free\") +\n        labs(title = \"Diagramas de cajas de las variables numéricas según Infarto\")\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-29-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Dibujar un diagrama de correlación entre las variables numéricas del conjunto de datos.\n\n    :::{.callout-note collapse=\"true\"}\n    ## Ayuda\n    Utilizar la función [`ggcorr`](https://ggobi.github.io/ggally/reference/ggcorr.html) del paquete [`GGally`](https://ggobi.github.io/ggally/) para dibujar un diagrama de correlación entre las variables numéricas del conjunto de datos. \n    \n    Parámetros:\n    - `label = TRUE` para mostrar las etiquetas de correlación.\n    :::\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df |>\n        select_if(is.numeric) |> \n        ggcorr(label = TRUE, label_size = 5)\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-30-1.png){width=672}\n    :::\n    :::\n\n    :::\n\na.  Descomponer el conjunto de datos en un subconjunto de entrenamiento con el 80% de los datos y un subconjunto de test con el 20% restante.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    library(tidymodels)\n    df_particion <- initial_split(df, prop = 0.8)  # Dividir el conjunto de datos en entrenamiento (80%) y test (20%)\n    df_entrenamiento <- training(df_particion)\n    df_test <- testing(df_particion)\n    ```\n    :::\n\n    :::\n\na.  Preprocesar el conjunto de datos de entrenamiento para eliminar las variables numéricas con alta correlación, normalizar las variables numéricas y crear variables dummy para las variables categóricas.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    receta <- recipe(Infarto ~ ., data = df_entrenamiento) |> \n        step_corr(all_numeric_predictors(), threshold = 0.8) |> # Eliminamos las variables numéricas con alta correlación para evitar multicolinealidad.\n        step_normalize(all_numeric_predictors()) |> # Normalizamos las variables predictivas numéricas.\n        step_dummy(all_nominal_predictors()) # Creamos variables dummy para las variables categóricas.\n    summary(receta)\n    ```\n    \n    ::: {.cell-output .cell-output-stdout}\n    \n    ```\n    # A tibble: 12 × 4\n       variable        type      role      source  \n       <chr>           <list>    <chr>     <chr>   \n     1 Edad            <chr [2]> predictor original\n     2 Sexo            <chr [3]> predictor original\n     3 DolorPecho      <chr [3]> predictor original\n     4 PresionArterial <chr [2]> predictor original\n     5 Colesterol      <chr [2]> predictor original\n     6 Glucemia        <chr [3]> predictor original\n     7 Electro         <chr [3]> predictor original\n     8 Pulsaciones     <chr [2]> predictor original\n     9 AnginaEjercicio <chr [3]> predictor original\n    10 DepresionST     <chr [2]> predictor original\n    11 PendienteST     <chr [3]> predictor original\n    12 Infarto         <chr [3]> outcome   original\n    ```\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Ajustar un modelo de regresión logística a los datos de entrenamiento utilizando la receta de preprocesamiento definida anteriormente.\n\n    :::{.callout-note collapse=\"true\"}\n    ## Ayuda\n    Usar la función [`logistic_reg`](https://parsnip.tidymodels.org/reference/logistic_reg.html) del paquete [`parsnip`](https://parsnip.tidymodels.org/index.html) para crear un modelo de regresión logística y establecer el motor de cálculo como \"glm\" (máxima verosimilitud) y el modo de clasificación para que devuelva la clase predicha.\n    :::\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    modelo <- logistic_reg() |> \n        set_engine(\"glm\") |>  # Establecer como motor de cálculo el ajuste por máxima verosimilitud.\n        set_mode(\"classification\") # Establecer el modo de clasificación para el modelo de regresión logística.\n    \n    modelo_ajustado <- workflow() |> \n        add_recipe(receta) |> # Añadir la receta al flujo de ajuste.\n        add_model(modelo) |> # Añadir el modelo al flujo de ajuste.\n        fit(data = df_entrenamiento) # Ajustar el modelo a los datos de entrenamiento.\n    \n    tidy(modelo_ajustado) |> \n    kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |term                    |   estimate| std.error|  statistic|   p.value|\n    |:-----------------------|----------:|---------:|----------:|---------:|\n    |(Intercept)             | -0.2407826| 0.3300296| -0.7295788| 0.4656477|\n    |Edad                    |  0.1389386| 0.1373853|  1.0113060| 0.3118700|\n    |PresionArterial         |  0.0605694| 0.1213331|  0.4991994| 0.6176389|\n    |Colesterol              | -0.4125356| 0.1286008| -3.2078782| 0.0013372|\n    |Pulsaciones             |  0.0156100| 0.1431990|  0.1090092| 0.9131952|\n    |DepresionST             |  0.3627497| 0.1377281|  2.6338109| 0.0084432|\n    |Sexo_M                  | -1.5678374| 0.3128149| -5.0120300| 0.0000005|\n    |DolorPecho_ATA          | -2.0664503| 0.3752431| -5.5069646| 0.0000000|\n    |DolorPecho_NAP          | -1.7653680| 0.2965727| -5.9525639| 0.0000000|\n    |DolorPecho_TA           | -1.4448772| 0.4494827| -3.2145333| 0.0013066|\n    |Glucemia_Sí             |  1.0373449| 0.3126080|  3.3183567| 0.0009055|\n    |Electro_Normal          | -0.1145730| 0.3004416| -0.3813487| 0.7029445|\n    |Electro_ST              |  0.0286894| 0.3840225|  0.0747076| 0.9404474|\n    |AnginaEjercicio_S       |  0.8841124| 0.2707438|  3.2654949| 0.0010927|\n    |PendienteST_Descendente |  0.9493212| 0.5078145|  1.8694250| 0.0615637|\n    |PendienteST_Plano       |  2.3608114| 0.2750711|  8.5825485| 0.0000000|\n    \n    \n    :::\n    :::\n\n    :::\n\n\na.  Usar el modelo de regresión logística ajustado para predecir el riesgo de infarto en el conjunto de test y mostrar las primeras 10 predicciones.\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    predict(modelo_ajustado, new_data = df_test) |> \n        head() |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.pred_class |\n    |:-----------|\n    |Sí          |\n    |No          |\n    |Sí          |\n    |No          |\n    |Sí          |\n    |No          |\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Añadir al conjunto de test la clase predicha con el modelo de regresión logístcia, así como las probabilidades de infarto predichas.\n\n    :::{.callout-note collapse=\"true\"}\n    ## Ayuda\n    Usar la función [`augment`](https://parsnip.tidymodels.org/reference/augment.html?q=augment#null) del paquete [`parsnip`](https://parsnip.tidymodels.org/index.html) para añadir al conjunto de test las probabilidades de infarto predichas por el modelo de regresión logística.\n    :::\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df_test <- augment(modelo_ajustado, new_data = df_test)\n    df_test |> \n        head() |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.pred_class |  .pred_No|  .pred_Sí| Edad|Sexo |DolorPecho | PresionArterial| Colesterol|Glucemia |Electro | Pulsaciones|AnginaEjercicio | DepresionST|PendienteST |Infarto |\n    |:-----------|---------:|---------:|----:|:----|:----------|---------------:|----------:|:--------|:-------|-----------:|:---------------|-----------:|:-----------|:-------|\n    |Sí          | 0.1988451| 0.8011549|   48|M    |ASY        |             138|        214|No       |Normal  |         108|S               |         1.5|Plano       |Sí      |\n    |No          | 0.9600342| 0.0399658|   39|H    |NAP        |             120|        339|No       |Normal  |         170|N               |         0.0|Ascendente  |No      |\n    |Sí          | 0.0595393| 0.9404607|   49|H    |ASY        |             140|        234|No       |Normal  |         140|S               |         1.0|Plano       |Sí      |\n    |No          | 0.9627125| 0.0372875|   32|H    |ATA        |             125|        254|No       |Normal  |         155|N               |         0.0|Ascendente  |No      |\n    |Sí          | 0.0563320| 0.9436680|   43|H    |ASY        |             120|        175|No       |Normal  |         120|S               |         1.0|Plano       |Sí      |\n    |No          | 0.9904237| 0.0095763|   41|M    |ATA        |             130|        245|No       |Normal  |         150|N               |         0.0|Ascendente  |No      |\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Evaluar el rendimiento del modelo de regresión logística en el conjunto de test utilizando las siguientes métricas de clasificación: precisión, sensibilidad, especificidad, exactitud, recall y F1-score.\n\n    :::{.callout-note collapse=\"true\"}\n    ## Ayuda\n    Utilizar la función [`metric_set`](https://yardstick.tidymodels.org/reference/metric_set.html) del paquete [`yardstick`](https://yardstick.tidymodels.org/index.html) para crear un conjunto de métricas de clasificación y pasarle el conjunto de datos de test aumentado con las probabilidades de infarto predichas.\n\n    Las métricas más habituales se calculan a partir de la matriz de confusión.\n\n    |                    | **Predicción Positiva** | **Predicción Negativa** |\n    |--------------------|-------------------------|-------------------------|\n    | **Real Positivo**  | VP (Verdaderos Positivos) | FN (Falsos Negativos) |\n    | **Real Negativo**  | FP (Falsos Positivos)   | VN (Verdaderos Negativos) |\n\n    - Exactitud (Accuracy): Proporción de predicciones correctas sobre el total de predicciones: (VP + VN) / (VP + VN + FP + FN). Es la métrica más básica.\n    - Precisión (Precision): Proporción de predicciones positivas correctas. Mide qué tan \"preciso\" es el modelo cuando predice positivo: VP / (VP + FP).\n    - Sensibilidad/Recall: Proporción de casos positivos reales que fueron correctamente clasificados por el modelo: VP / (VP + FN). También se llama \"tasa de verdaderos positivos\".\n    - Especificidad: Proporción de casos negativos reales que fueron correctamente clasificados por el modelo: VN / (VN + FP). Es la \"tasa de verdaderos negativos\".\n    - F1-score: Media armónica entre precisión y recall: 2 × (Precisión × Recall) / (Precisión + Recall). Es útil cuando quieres balancear tanto la precisión como el recall, especialmente con clases desbalanceadas.\n    :::\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    metricas <- metric_set(accuracy, sensitivity, specificity, precision, f_meas)\n    df_test |> \n        metricas(truth = Infarto, estimate = .pred_class) |> \n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.metric     |.estimator | .estimate|\n    |:-----------|:----------|---------:|\n    |accuracy    |binary     | 0.8913043|\n    |sensitivity |binary     | 0.8444444|\n    |specificity |binary     | 0.9361702|\n    |precision   |binary     | 0.9268293|\n    |f_meas      |binary     | 0.8837209|\n    \n    \n    :::\n    :::\n\n    :::\n\na.  Dibujar la curva ROC del modelo de regresión logística y calcular el área bajo la curva (AUC).\n\n    :::{.callout-note collapse=\"true\"}\n    ## Ayuda\n    Utilizar la función [`roc_curve`](https://yardstick.tidymodels.org/reference/roc_curve.html) del paquete [`yardstick`](https://yardstick.tidymodels.org/index.html) para calcular la curva ROC y la función [`roc_auc`](https://yardstick.tidymodels.org/reference/roc_auc.html) para calcular el área bajo la curva (AUC).\n\n    Parámetros:\n    - `truth`: variable de verdad (real).\n    - `.pred_No`: probabilidad de la clase negativa.\n    :::\n\n    :::{.callout-tip collapse=\"true\"}\n    ## Solución\n\n\n    ::: {.cell}\n    \n    ```{.r .cell-code}\n    df_test|> \n        roc_curve(truth = Infarto, .pred_No) |>\n        autoplot()\n    ```\n    \n    ::: {.cell-output-display}\n    ![](03-regresion_files/figure-html/unnamed-chunk-37-1.png){width=672}\n    :::\n    \n    ```{.r .cell-code}\n    df_test |> \n        roc_auc(truth = Infarto, .pred_No) |>\n        kable()\n    ```\n    \n    ::: {.cell-output-display}\n    \n    \n    |.metric |.estimator | .estimate|\n    |:-------|:----------|---------:|\n    |roc_auc |binary     | 0.9419622|\n    \n    \n    :::\n    :::\n\n:::\n\n## Ejercicios propuestos\n\n:::{#exr-regresion-4}\nEl conjunto de datos [`neonatos`](https://aprendeconalf.es/estadistica-practicas-r/datos/neonatos.csv) contiene información sobre una muestra de 320 recién nacidos en un hospital durante un año que cumplieron el tiempo normal de gestación. \n\na.  Crear un data frame a con los datos de los neonatos a partir del fichero anterior.\n\na.  Construir la recta de regresión del peso de los recién nacidos sobre el número de cigarros fumados al día por las madres. ¿Existe una relación lineal fuerte entre el peso y el número de cigarros?\n\na.  Dibujar la recta de regresión calculada en el apartado anterior. ¿Por qué la recta no se ajusta bien a la nube de puntos?\n\na.  Calcular y dibujar la recta de regresión del peso de los recién nacidos sobre el número de cigarros fumados al día por las madres en el grupo de las madres que si fumaron durante el embarazo. ¿Es este modelo mejor o pero que la recta\ndel apartado anterior? \n\na.  Según este modelo, ¿cuánto disminuirá el peso del recién nacido por cada cigarro más diario que fume la madre? \n\na.  Según el modelo anterior, ¿qué peso tendrá un recién nacido de una madre que ha fumado 5 cigarros diarios durante el embarazo? ¿Y si la madre ha fumado 30 cigarros diarios durante el embarazo? ¿Son fiables estas predicciones?\n\na.  ¿Existe la misma relación lineal entre el peso de los recién nacidos y el número de cigarros fumados al día por las madres que fumaron durante el embarazo en el grupo de las madres menores de 20 y en el grupo de las madres mayores de\n20? ¿Qué se puede concluir?",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}